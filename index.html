<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tab Manager with Environments</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" href="images/favicon.png" type="image/png">
    <script src="https://sdk.amazonaws.com/js/aws-sdk-2.163.0.min.js"></script>
    <style>
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: #2c3e50;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .header {
            background: #34495e;
            color: white;
            padding: 15px 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            position: relative;
            z-index: 200;
        }       
                
        .main-container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }
                                     
        
    </style>
    <link rel="stylesheet" href="css/Responsive_design.css">
    <link rel="stylesheet" href="css/search-suggestion.css">
    <link rel="stylesheet" href="css/Move_shevron_rotation.css">
    <link rel="stylesheet" href="css/multylink_styles.css">
    <link rel="stylesheet" href="css/Color_Palette_Styles.css">
    <link rel="stylesheet" href="css/Search_count_badge.css">
    <link rel="stylesheet" href="css/Environments.css">
    <link rel="stylesheet" href="css/Links.css">
    <link rel="stylesheet" href="css/Reorder_links.css">
    <link rel="stylesheet" href="css/Tabs.css">
    <link rel="stylesheet" href="css/Profiles.css">
    <link rel="stylesheet" href="css/Modal_styles.css">
    <link rel="stylesheet" href="css/Rename_modal.css">
    <link rel="stylesheet" href="css/Move_link_modal.css">
    <link rel="stylesheet" href="css/Move_link_environment.css">
    <link rel="stylesheet" href="css/Move_tab_modal.css">
    <link rel="stylesheet" href="css/Search_container_styles.css">
    <link rel="stylesheet" href="css/Profile_tab_color_styling.css">
    <link rel="stylesheet" href="css/Color_picker.css">
    <link rel="stylesheet" href="css/Bulk_action.css">
    <link rel="stylesheet" href="css/Cross_profile_movement.css">
    <link rel="stylesheet" href="css/Selection_checkboxes.css">
    <link rel="stylesheet" href="css/Workbooks.css">
    <link rel="stylesheet" href="css/Trash_bin.css">
    <link rel="stylesheet" href="css/Table_view.css">
    <link rel="stylesheet" href="css/List_view.css">
    <link rel="stylesheet" href="css/Header-actions.css">
    <link rel="stylesheet" href="css/Grid_view.css">
    <link rel="stylesheet" href="css/Search_highlights.css">
    <link rel="stylesheet" href="css/logo.css">
    <link rel="stylesheet" href="css/panel-title.css">
    <link rel="stylesheet" href="css/side-panel.css">
    <link rel="stylesheet" href="css/profiles-container.css">
    <link rel="stylesheet" href="css/counters.css">
    <link rel="stylesheet" href="css/s3-sync.css">
    <link rel="stylesheet" href="css/email.css">
    <link rel="stylesheet" href="css/destination_for_move_profile.css">
    <link rel="stylesheet" href="css/destination_for_move_environment.css">
    <link rel="stylesheet" href="css/destination_for_move_tabs.css">

</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="logo">
            <i class="fas fa-table"></i>
            <span>Tab Manager</span>
                <div class="counters">
                <span class="counter-item" id="workbooks-counter">0 Workbooks</span>
                <span class="counter-item" id="profiles-counter">0 Profiles</span>
                <span class="counter-item" id="environments-counter">0 Environments</span>
                <span class="counter-item" id="tabs-counter">0 Tabs</span>
                <span class="counter-item" id="links-counter">0 Links</span>
            </div>
        </div>
        <div class="search-container">
            <i class="fas fa-search"></i>
            <input type="text" id="global-search" placeholder="Search across all workbooks...">
            <span class="search-clear" id="search-clear">
                <i class="fas fa-times"></i>
            </span>
            <!-- Search suggestions should be a sibling of the input -->
            <div class="search-suggestions" id="search-suggestions" style="display: none;">
                <div class="search-suggestions-header">
                    <span>Search Results</span>
                    <small id="search-results-count">0 results</small>
                </div>
                <div class="search-suggestions-list" id="search-suggestions-list">
                    <!-- Suggestions will be populated here -->
                </div>
            </div>
        </div>
        <div class="header-actions">
            <button class="trash-bin-btn" id="trash-bin-btn" title="Trash Bin">
                <i class="fas fa-trash"></i>Trash Bin
            </button>
            <button class="header-btn reorder-workbooks-btn" id="reorder-workbooks-btn" title="Reorder Workbooks">
                <i class="fas fa-sort"></i>Reorder Workbooks
            </button>
            <button class="header-btn reorder-profiles-btn" id="reorder-profiles-btn" title="Reorder Profiles">
                <i class="fas fa-sort"></i>Reorder Profiles
            </button>
            <button class="header-btn export-btn" id="export-btn">
                <i class="fas fa-download"></i>Export to XML
            </button>
            <button class="header-btn import-btn" id="import-btn">
                <i class="fas fa-upload"></i>Import from XML
            </button>
            <button class="header-btn" id="migrate-data-btn" style="background: #e67e22;">
                <i class="fas fa-history"></i>Migrate Old Data
            </button>
            
        </div>
    </div>

    <!-- NEW: Workbook tabs -->
    <div class="workbook-tabs-container" id="workbook-tabs-container">
        <!-- Workbook tabs will be added here dynamically -->
        <button class="add-workbook-tab" id="add-workbook-tab-btn" title="Add New Workbook">
            <i class="fas fa-plus"></i>
        </button>
    </div>

    <!-- NEW: Profile tabs -->
    <div class="profile-tabs-container" id="profile-tabs-container">
        <!-- Profile tabs will be added here dynamically -->
        <button class="add-profile-tab" id="add-profile-tab-btn" title="Add New Profile">
            <i class="fas fa-plus"></i>
        </button>
    </div>
    
     <!-- Main Content -->
    <div class="main-container">
        <!-- Left Frame - Side Panel -->
        <div class="side-panel">
            <!-- Profile Selector (hidden) -->
            <div class="profiles-container">
                <div class="profile-selector">
                    <select class="profile-select" id="profile-select"></select>
                    <button class="profile-action-btn" id="add-profile-btn" title="Add New Profile">
                        <i class="fas fa-plus"></i>
                    </button>
                    <button class="profile-action-btn" id="edit-profile-btn" title="Rename Profile">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="profile-action-btn" id="delete-profile-btn" title="Delete Profile">
                        <i class="fas fa-trash"></i>
                    </button>
                    <!-- <button class="header-btn reorder-profiles-btn" id="reorder-profiles-btn" title="Reorder Profiles" style="margin-left: 10px;"> -->
                    <!--     <i class="fas fa-sort"></i>Reorder Profiles -->
                    <!-- </button> -->
                </div>
            </div>
            
            <div class="panel-title">
                <span>My Environments</span>
                <div>
                    <button class="add-environment-btn" id="reorder-environments-btn" title="Reorder Environments" style="margin-right: 10px;">
                        <i class="fas fa-sort"></i>
                    </button>
                    <button class="add-environment-btn" id="add-environment-btn" title="Add New Environment">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
            </div>
            <div class="environments-container" id="environments-container">
                <!-- Environments will be added here dynamically -->
            </div>
            <div class="add-tab-container">
                <button class="add-tab" id="add-tab-btn">
                    <i class="fas fa-plus plus-icon"></i> New Tab
                </button>
            </div>
        </div>
        
        
        <!-- Right Frame - Content Panel -->
        <div class="content-panel">
            <div class="tab-header">
                <div class="tab-title" id="current-tab-name">Select a tab to get started</div>
                <div class="tab-actions">
                    <div class="view-type-dropdown">
                        <button class="view-type-toggle" id="view-type-toggle">
                            <i class="fas fa-th"></i>
                            <span>View</span>
                            <i class="fas fa-chevron-down"></i>
                        </button>
                        <div class="view-type-menu" id="view-type-menu">
                            <button class="view-type-option" data-view-type="grid">
                                <i class="fas fa-th"></i>
                                <span>Grid View</span>
                            </button>
                            <button class="view-type-option" data-view-type="list">
                                <i class="fas fa-list"></i>
                                <span>List View</span>
                            </button>
                            <button class="view-type-option" data-view-type="table">
                                <i class="fas fa-table"></i>
                                <span>Table View</span>
                            </button>
                        </div>
                    </div>
                    <button id="toggle-selection-mode-btn" style="display: none;">
                        <i class="fas fa-check-square"></i>Select Links
                    </button>
                    <button id="reorder-links-btn" style="display: none;">
                        <i class="fas fa-sort"></i>Reorder Links
                    </button>
                    <button id="add-multi-link-card-btn" style="display: none;">
                        <i class="fas fa-layer-group"></i>Add Multi-Link Card
                    </button>
                    <button id="create-search-link-btn" style="display: none;">
                        <i class="fas fa-search-plus"></i>Create Search Link
                    </button>
                    <button class="header-btn" id="create-outlook-email-btn" style="background: #0078d4;">
                        <i class="fas fa-envelope"></i>Create Outlook Email
                    </button>
                    <button id="add-link-btn">
                        <i class="fas fa-plus plus-icon"></i>Add Link
                    </button>
                </div>
            </div>
            
            <div class="links-container" id="links-container">
                <div class="no-links-message" id="no-tabs-message">
                    <h2>Welcome to Tab Manager</h2>
                    <p>Create your first workbook, profile, environment and tab to get started!</p>
                </div>
                
                <div class="links-grid" id="links-grid" style="display: none;">
                    <!-- Links will be added here dynamically -->
                </div>
            </div>
            
            <div class="add-link-section" id="add-link-section" style="display: none;">
                <div class="add-link-form">
                    <div class="form-group">
                        <label for="link-title">Title</label>
                        <input type="text" id="link-title" placeholder="Enter link title">
                    </div>
                    <div class="form-group">
                        <label for="link-url">URL</label>
                        <input type="text" id="link-url" placeholder="https://example.com">
                    </div>
                    <button class="add-link-btn" id="add-link-submit-btn">Add Link</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Workbook Modal -->
    <div class="modal" id="workbook-modal">
        <div class="workbook-modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Add New Workbook</h3>
                <span class="close-modal">&times;</span>
            </div>
            <input type="text" class="rename-input" id="new-workbook-name" placeholder="Enter workbook name">
            <div class="modal-actions">
                <button class="modal-btn modal-btn-secondary" id="close-workbook-modal">Cancel</button>
                <button class="modal-btn modal-btn-primary" id="save-workbook-btn">Save</button>
            </div>
        </div>
    </div>

      
    <!-- Export Modal -->
    <div class="modal" id="export-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Export to XML</h3>
                <span class="close-modal">&times;</span>
            </div>
            <p>Copy this XML to save your environments, tabs and links:</p>
            <textarea class="modal-textarea" id="export-xml-content" readonly></textarea>
            <div class="modal-actions">
                <button class="modal-btn modal-btn-secondary" id="close-export-modal">Close</button>
                <button class="modal-btn modal-btn-primary" id="copy-xml-btn">
                    <i class="fas fa-copy"></i>Copy to Clipboard
                </button>
                <button class="modal-btn modal-btn-success" id="download-xml-btn">
                    <i class="fas fa-download"></i>Download XML File
                </button>
            </div>
        </div>
    </div>

    <!-- Import Modal -->
    <div class="modal" id="import-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Import from XML</h3>
                <span class="close-modal">&times;</span>
            </div>
            <p>Paste your XML data here to import environments, tabs and links:</p>
            <textarea class="modal-textarea" id="import-xml-content" placeholder="Paste XML here..."></textarea>
            <div class="modal-actions">
                <button class="modal-btn modal-btn-secondary" id="close-import-modal">Close</button>
                <button class="modal-btn modal-btn-success" id="import-xml-btn">
                    <i class="fas fa-file-import"></i>Import Data
                </button>
            </div>
        </div>
    </div>

    <!-- Add Environment Modal -->
    <div class="modal" id="environment-modal">
        <div class="environment-modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Add New Environment</h3>
                <span class="close-modal">&times;</span>
            </div>
            <input type="text" class="rename-input" id="new-environment-name" placeholder="Enter environment name">
            <div class="modal-actions">
                <button class="modal-btn modal-btn-secondary" id="close-environment-modal">Cancel</button>
                <button class="modal-btn modal-btn-primary" id="save-environment-btn">Save</button>
            </div>
        </div>
    </div>

    <!-- Add Tab Modal -->
    <div class="modal" id="tab-modal">
        <div class="rename-modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Add New Tab</h3>
                <span class="close-modal">&times;</span>
            </div>
            <input type="text" class="rename-input" id="new-tab-name" placeholder="Enter tab name">
            <div class="modal-actions">
                <button class="modal-btn modal-btn-secondary" id="close-tab-modal">Cancel</button>
                <button class="modal-btn modal-btn-primary" id="save-tab-btn">Save</button>
            </div>
        </div>
    </div>

    <!-- Update the move link modal to include the destination path -->
    <div class="modal" id="move-link-modal">
        <div class="move-link-modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Move Link</h3>
                <span class="close-modal">&times;</span>
            </div>
            <p>Select a destination tab for this link:</p>
            
            <!-- Add the destination path display here -->
            <div class="selected-destination-path" id="selected-destination-path" style="display: none;">
                <!-- Selected path will be shown here -->
            </div>
            
            <div id="move-link-destinations">
                <!-- Destinations will be populated here -->
            </div>
            <div class="modal-actions">
                <button class="modal-btn modal-btn-secondary" id="close-move-link-modal">Cancel</button>
                <button class="modal-btn modal-btn-primary" id="save-move-link-btn">Move</button>
            </div>
        </div>
    </div>

    <!-- Profile Modal -->
    <div class="modal" id="profile-modal">
        <div class="profile-modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Add New Profile</h3>
                <span class="close-modal">&times;</span>
            </div>
            <input type="text" class="rename-input" id="new-profile-name" placeholder="Enter profile name">
            <div class="modal-actions">
                <button class="modal-btn modal-btn-secondary" id="close-profile-modal">Cancel</button>
                <button class="modal-btn modal-btn-primary" id="save-profile-btn">Save</button>
            </div>
        </div>
    </div>

    <!-- Add Multi-Link Card Modal -->
    <div class="modal" id="multi-link-card-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Add Multi-Link Card</h3>
                <span class="close-modal">&times;</span>
            </div>
            <div class="form-group">
                <label for="multi-link-card-name">Card Name</label>
                <input type="text" id="multi-link-card-name" placeholder="Enter card name">
            </div>
            <div id="multi-link-fields-container">
                <div class="multi-link-field">
                    <label>Link 1</label>
                    <div class="link-input-with-action">
                        <input type="text" class="multi-link-url" placeholder="https://example.com">
                        <button type="button" class="add-link-field-btn">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                </div>
            </div>
            <div class="modal-actions">
                <button class="modal-btn modal-btn-secondary" id="close-multi-link-card-modal">Cancel</button>
                <button class="modal-btn modal-btn-primary" id="save-multi-link-card-btn">Save</button>
            </div>
        </div>
    </div>

    <!-- Edit Multi-Link Card Modal -->
    <div class="modal" id="edit-multi-link-card-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Edit Multi-Link Card</h3>
                <span class="close-modal">&times;</span>
            </div>
            <div class="form-group">
                <label for="edit-multi-link-card-name">Card Name</label>
                <input type="text" id="edit-multi-link-card-name" placeholder="Enter card name">
            </div>
            <div id="edit-multi-link-fields-container">
                <!-- Dynamic fields will be added here -->
            </div>
            <div class="modal-actions">
                <button class="modal-btn modal-btn-secondary" id="close-edit-multi-link-card-modal">Cancel</button>
                <button class="modal-btn modal-btn-primary" id="save-edit-multi-link-card-btn">Save</button>
            </div>
        </div>
    </div>

   <!-- Create Search Link Modal -->
    <div class="modal" id="create-search-link-modal">
        <div class="search-link-modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Create Search Link</h3>
                <span class="close-modal">&times;</span>
            </div>
            <div class="search-link-description">
                Create a link with a search parameter that can be filled when opening the link.
            </div>
            <div class="form-group">
                <label for="search-link-title">Title</label>
                <input type="text" id="search-link-title" placeholder="Enter link title">
            </div>
            <div class="form-group">
                <label for="search-link-url">URL with Search Parameter</label>
                <input type="text" id="search-link-url" placeholder="https://example.com/search?q={search}">
            </div>
            <div class="search-link-preview" id="search-link-preview">
                Preview: <span id="search-link-preview-text">Enter URL to see preview</span>
            </div>
            <div class="modal-actions">
                <button class="modal-btn modal-btn-secondary" id="close-create-search-link-modal">Cancel</button>
                <button class="modal-btn modal-btn-primary" id="save-search-link-btn">Create Search Link</button>
            </div>
        </div>
    </div>

    <!-- Search Value Input Modal -->
    <div class="modal" id="search-value-modal">
        <div class="rename-modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Enter Search Value</h3>
                <span class="close-modal">&times;</span>
            </div>
            <div class="search-link-preview" id="search-value-preview">
                URL: <span id="search-value-preview-text"></span>
            </div>
            <input type="text" class="rename-input" id="search-value-input" placeholder="Enter search value">
            <div class="modal-actions">
                <button class="modal-btn modal-btn-secondary" id="close-search-value-modal">Cancel</button>
                <button class="modal-btn modal-btn-primary" id="open-search-link-btn">Open Link</button>
            </div>
        </div>
    </div>

    <!-- Search Suggestions Dropdown -->
    <!-- <div class="search-suggestions" id="search-suggestions" style="display: none;"> -->
    <!--     <div class="search-suggestions-header"> -->
    <!--         <span>Search Results</span> -->
    <!--         <small id="search-results-count">0 results</small> -->
    <!--     </div> -->
    <!--     <div class="search-suggestions-list" id="search-suggestions-list"> -->
            <!-- Suggestions will be populated here -->
    <!--     </div> -->
    <!-- </div> -->

    <!-- Bulk Action Bar -->
    <div class="bulk-action-bar" id="bulk-action-bar">
        <div class="bulk-selection-count" id="bulk-selection-count">0 items selected</div>
        <button class="bulk-action-btn bulk-clone-btn" id="bulk-clone-to-tab-btn">
            <i class="fas fa-copy"></i>Clone to Tab
        </button>
        <button class="bulk-action-btn bulk-clone-btn" id="bulk-clone-btn">
            <i class="fas fa-copy"></i>Clone Selected
        </button>
        <button class="bulk-action-btn bulk-move-btn" id="bulk-move-btn">
            <i class="fas fa-arrows-alt"></i>Move Selected
        </button>
        <button class="bulk-action-btn bulk-delete-btn" id="bulk-delete-btn">
            <i class="fas fa-trash"></i>Delete Selected
        </button>
        <button class="bulk-action-btn bulk-cancel-btn" id="bulk-cancel-btn">
            <i class="fas fa-times"></i>Cancel
        </button>
    </div>

    <!-- Clone to Tab Modal -->
    <div class="modal" id="clone-to-tab-modal">
        <div class="move-link-modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="clone-modal-title">Clone Links to Tab</h3>
                <span class="close-modal">&times;</span>
            </div>
            <p>Select a destination tab for the cloned links:</p>
            <div id="clone-link-destinations">
                <!-- Destinations will be populated here -->
            </div>
            <div class="selected-destination-path" id="clone-destination-path" style="display: none;">
                <!-- Selected path will be shown here -->
            </div>
            <div class="modal-actions">
                <button class="modal-btn modal-btn-secondary" id="close-clone-to-tab-modal">Cancel</button>
                <button class="modal-btn modal-btn-primary" id="save-clone-to-tab-btn">
                    <i class="fas fa-copy"></i>Clone Links
                </button>
            </div>
        </div>
    </div>

    <div class="modal" id="trash-bin-modal">
        <div class="trash-bin-modal-content">
            <div class="trash-bin-header">
                <h3 class="modal-title">Trash Bin</h3>
                <span class="close-modal">&times;</span>
            </div>
            <div class="trash-bin-count" id="trash-bin-count">0 items in trash</div>
            <div id="trash-bin-items">
                <!-- Trash bin items will be populated here -->
            </div>
            <div class="modal-actions">
                <button class="modal-btn modal-btn-secondary" id="close-trash-bin-modal">Close</button>
                <button class="modal-btn trash-bin-clear-all-btn" id="clear-trash-bin-btn">
                    <i class="fas fa-trash"></i>Empty Trash Bin
                </button>
            </div>
        </div>
    </div>

    <!-- Outlook Email Modal -->
    <div class="modal" id="outlook-email-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Create Outlook Email Link</h3>
                <span class="close-modal">&times;</span>
            </div>
            <div class="form-group">
                <label for="email-from">From (optional - usually auto-filled by Outlook)</label>
                <input type="email" id="email-from" placeholder="sender@example.com">
            </div>
            <div class="form-group">
                <label for="email-to">To (required, separate multiple with semicolons)</label>
                <input type="text" id="email-to" placeholder="recipient1@example.com; recipient2@example.com" required>
            </div>
            <div class="form-group">
                <label for="email-cc">CC (optional, separate multiple with semicolons)</label>
                <input type="text" id="email-cc" placeholder="cc1@example.com; cc2@example.com">
            </div>
            <div class="form-group">
                <label for="email-subject">Subject (optional)</label>
                <input type="text" id="email-subject" placeholder="Email subject">
            </div>
            <div class="form-group">
                <label for="email-body">Body (optional)</label>
                <textarea id="email-body" placeholder="Email body content" rows="4"></textarea>
            </div>
            <div class="email-preview" id="email-preview">
                <strong>Preview:</strong> <span id="email-preview-text">mailto:...</span>
            </div>
            <div class="modal-actions">
                <button class="modal-btn modal-btn-secondary" id="close-outlook-email-modal">Cancel</button>
                <button class="modal-btn modal-btn-primary" id="save-outlook-email-btn">Create Email Link</button>
            </div>
        </div>
    </div>
   

    <script>
        // Updated data structure with workbooks
        let workbooks = [];
        let currentWorkbookId = null;
        let currentProfileId = null;
        let currentEnvironment = null;
        let currentTab = null;
        let linkToMove = null;
        let tabToMove = null;
        let linkToEdit = null;
        let environmentToRename = null;
        let tabToRename = null;
        let profileToRename = null;
        let workbookToRename = null;
        let selectedDestinationTab = null;
        let selectedDestinationEnvironment = null;
        let environmentToMove = null;
        let selectedDestinationProfile = null;
        let multiLinkCardToEdit = null;
        let selectedColor = '#3498db';
        let profileForColor = null;
        let searchLinkToOpen = null;
        let isCreatingSearchLink = false;
        let selectedLinks = new Set();
        let isSelectionMode = false;
        let currentViewType = 'grid';
        let trashBin = [];

        // DOM Elements
        const workbookTabsContainer = document.getElementById('workbook-tabs-container');
        const addWorkbookTabBtn = document.getElementById('add-workbook-tab-btn');
        const environmentsContainer = document.getElementById('environments-container');
        const linksGrid = document.getElementById('links-grid');
        const noTabsMessage = document.getElementById('no-tabs-message');
        const currentTabName = document.getElementById('current-tab-name');
        const addLinkSection = document.getElementById('add-link-section');
        const addLinkSubmitBtn = document.getElementById('add-link-submit-btn');
        const reorderLinksBtn = document.getElementById('reorder-links-btn');
        const addTabBtn = document.getElementById('add-tab-btn');
        const addEnvironmentBtn = document.getElementById('add-environment-btn');
        const exportBtn = document.getElementById('export-btn');
        const importBtn = document.getElementById('import-btn');
        const exportModal = document.getElementById('export-modal');
        const importModal = document.getElementById('import-modal');
        const environmentModal = document.getElementById('environment-modal');
        const renameEnvironmentModal = document.getElementById('rename-environment-modal');
        const tabModal = document.getElementById('tab-modal');
        const renameTabModal = document.getElementById('rename-tab-modal');
        const editLinkModal = document.getElementById('edit-link-modal');
        const moveLinkModal = document.getElementById('move-link-modal');
        const moveTabModal = document.getElementById('move-tab-modal');
        const reorderLinksModal = document.getElementById('reorder-links-modal');
        const profileModal = document.getElementById('profile-modal');
        const renameProfileModal = document.getElementById('rename-profile-modal');
        const profileTabsContainer = document.getElementById('profile-tabs-container');
        const addProfileTabBtn = document.getElementById('add-profile-tab-btn');
        const globalSearch = document.getElementById('global-search');
        const searchClear = document.getElementById('search-clear');
        const workbookModal = document.getElementById('workbook-modal');
        const renameWorkbookModal = document.getElementById('rename-workbook-modal');
        const reorderWorkbooksModal = document.getElementById('reorder-workbooks-modal');  
        const originalSaveWorkbooks = window.saveWorkbooks;
        window.saveWorkbooks = function() {
            console.trace('saveWorkbooks called from:');
            return originalSaveWorkbooks.apply(this, arguments);
        };    

        // ===== VERSION-AWARE STORAGE MANAGER =====
        const APP_VERSION = 'v18-search'; // UNIQUE FOR V18

        function init() {
            console.log('Initializing V18 Tab Manager...');
            
            // Migrate to versioned storage first
            migrateToVersionedStorage();
            
            // Load versioned data
            loadWorkbooks();
            loadTrashBin();

            debugCurrentState();
            const duplicates = findDuplicateElements();
            
            // Continue with existing initialization
            migrateOldData();
            
            // Render UI components
            renderWorkbookTabs();
            renderProfileTabs();
            renderEnvironments();
            // initializeS3Config();
            // Initialize counters
            if (typeof updateAllCounters === 'function') {
                updateAllCounters();
            }
            
            // Setup event listeners
            if (typeof setupEventListeners === 'function') {
                const success = setupEventListeners();
                if (!success) {
                    console.error('Failed to setup event listeners');
                    setTimeout(setupEventListeners, 100);
                }
            }
            
            setupProfileTabsScrolling();
            positionSearchSuggestions();
            
            // Create default workbook if none exist
            if (workbooks.length === 0) {
                createDefaultWorkbook();
            }
            
            // Set initial selections
            if (workbooks.length > 0) {
                currentWorkbookId = workbooks[0].id;
                renderProfileTabs();
                
                const currentWorkbook = getCurrentWorkbook();
                if (currentWorkbook.profiles.length > 0) {
                    currentProfileId = currentWorkbook.profiles[0].id;
                    renderEnvironments();
                }
            }
            
            // Optional: Auto-refresh counters every 3 seconds as backup
            setInterval(() => {
                if (typeof updateAllCounters === 'function') {
                    updateAllCounters();
                }
            }, 3000);
            
            console.log(`V18 Tab Manager initialized successfully with version: ${APP_VERSION}`);

            setTimeout(verifyAllFixes, 500);
            // setTimeout(testImportExport, 1000);
        }

        
        
                
                
        // Initialize the application when the page loads
        document.addEventListener('DOMContentLoaded', init);

    </script>

    <!-- 1. Core utilities first -->
    <script src="js/getCurrentProfile.js"></script>
    <script src="js/getCurrentWorkbook.js"></script>

    <!-- 2. Rendering functions that renderEnvironments depends on -->
    <script src="js/renderTabs.js"></script>

    <!-- 3. renderEnvironments itself -->
    <script src="js/render-environments.js"></script>
   
    <script src="js/importSearchLink.js"></script>
    <script src="js/openMoveLinkModal.js"></script>
    <script src="js/exportToXML.js"></script>
    <script src="js/addCheckboxesToAllViews.js"></script>
    <script src="js/addCheckboxesToGridView.js"></script>
    <script src="js/addCheckboxesToListView.js"></script>
    <script src="js/addCheckboxesToTableView.js"></script>
    <script src="js/addCheckboxToElement.js"></script>
    <script src="js/removeCheckboxesFromLinks.js"></script>
    <script src="js/checkProfileScroll.js"></script>
    <script src="js/permanentlyDeleteFromTrash.js"></script>
    <script src="js/restoreFromTrash.js"></script>
    <script src="js/moveWorkbookUp.js"></script>
    <script src="js/moveWorkbookDown.js"></script>
    <script src="js/deleteWorkbook.js"></script>
    <script src="js/moveTabUp.js"></script>
    <script src="js/moveTabDown.js"></script>
    <script src="js/updateProfileScroll.js"></script>
    <script src="js/forceMigrateOldData.js"></script>
    <script src="js/openMoveProfileModal.js"></script>
    <script src="js/permanentlyDeleteLink.js"></script>
    <script src="js/restoreLink.js"></script>
    <script src="js/addCheckboxesToLinks.js"></script>
    <script src="js/removeCheckboxesFromAllViews.js"></script>
    <script src="js/toggleSelectionMode.js"></script>
    <script src="js/openSearchLink.js"></script>
    <script src="js/openSearchLinkModal.js"></script>
    <script src="js/saveSearchLink.js"></script>
    <script src="js/updateSearchLinkPreview.js"></script>
    <script src="js/openCreateSearchLinkModal.js"></script>
    <script src="js/workbook-color-modal.js"></script>
    <script src="js/updateProfileColor.js"></script>
    <script src="js/openMultiLinkCardLinks.js"></script>
    <script src="js/saveEditMultiLinkCard.js"></script>
    <script src="js/updateFieldLabelsEdit.js"></script>
    <script src="js/addLinkFieldEdit.js"></script>
    <script src="js/openEditMultiLinkCardModal.js"></script>
    <script src="js/saveMultiLinkCard.js"></script>
    <script src="js/updateFieldLabels.js"></script>
    <script src="js/addLinkField.js"></script>
    <script src="js/openMultiLinkCardModal.js"></script>
    <script src="js/openReorderTabsModal.js"></script>
    <script src="js/moveEnvironmentUp.js"></script>
    <script src="js/moveEnvironmentDown.js"></script>
    <script src="js/openReorderEnvironmentsModal.js"></script>
    <script src="js/moveProfileDown.js"></script>
    <script src="js/moveProfileUp.js"></script>
    <script src="js/highlightTab.js"></script>
    <script src="js/highlightEnvironment.js"></script>
    <script src="js/highlightProfileTab.js"></script>
    <script src="js/isProfileInCurrentWorkbook.js"></script>
    <script src="js/isProfileCurrent.js"></script>
    <script src="js/renderProfileTabs.js"></script>
    <script src="js/populateWorkbookProfiles.js"></script>
    <script src="js/openMoveEnvironmentModal.js"></script>
    <script src="js/switchProfile.js"></script>
    <script src="js/deleteProfile.js"></script>
    <script src="js/addProfile.js"></script>
    <script src="js/escapeXml.js"></script>
    <script src="js/validateMultiLinkCard.js"></script>
    <script src="js/processMultiLinkUrls.js"></script>
    <script src="js/createTrashItem.js"></script>
    <script src="js/importRegularLink.js"></script>
    <script src="js/importMultiLink.js"></script>
    <script src="js/importLinks.js"></script>
    <script src="js/importTabs.js"></script>
    <script src="js/importEnvironments.js"></script>
    <script src="js/importProfiles.js"></script>
    <script src="js/importFromXML.js"></script>
    <script src="js/updateSelectedDestinationPath.js"></script>
    <script src="js/populateEnvironmentTabs.js"></script>
    <script src="js/populateProfileEnvironments.js"></script>
    <script src="js/openMoveTabModal.js"></script>
    <script src="js/attachLinkEventListeners.js"></script>
    <script src="js/createListViewLink.js"></script>
    <script src="js/createTableViewLink.js"></script>
    <script src="js/renderLinks.js"></script>
    <script src="js/selectTab.js"></script>
    <script src="js/saveReorderedWorkbooks.js"></script>
    <script src="js/renderWorkbookTabs.js"></script>
    <script src="js/moveLinkUp.js"></script>
    <script src="js/moveLinkDown.js"></script>
    <script src="js/openReorderLinksModal.js"></script>
    <script src="js/updateSelectedTabDestinationPath.js"></script>
    <script src="js/moveLink.js"></script>
    <script src="js/deleteTab.js"></script>
    <script src="js/deleteEnvironment.js"></script>
    <script src="js/addLink.js"></script>
    <script src="js/addTab.js"></script>
    <script src="js/addEnvironment.js"></script>
    <script src="js/switchWorkbook.js"></script>
    <script src="js/addWorkbook.js"></script>
    <script src="js/createDefaultProfile.js"></script>
    <script src="js/createDefaultWorkbook.js"></script>
    <script src="js/switchViewType.js"></script>
    <script src="js/saveWorkbooks.js"></script>
    <script src="js/loadWorkbooks.js"></script>
    <script src="js/migrateOldData.js"></script>
    <script src="js/updateWorkbookColor.js"></script>
    <script src="js/positionSearchSuggestions.js"></script>
    <script src="js/hideSearchSuggestions.js"></script>
    <script src="js/navigateToSearchResult.js"></script>
    <script src="js/getTypeAbbreviation.js"></script>
    <script src="js/escapeRegex.js"></script>
    <script src="js/highlightText.js"></script>
    <script src="js/showSearchSuggestions.js"></script>
    <script src="js/updateSearchResultsCount.js"></script>
    <script src="js/trash-bin-functions.js"></script>
    <!-- openTrashBinModal, clearTrashBin, restoreFromTrash, permanentlyDeleteFromTrash, deleteLink, 
     renderTrashBinModal, saveTrashBin, loadTrashBin, createTrashItem, importTrashBin-->
    <script src="js/createTabForClone.js"></script>
    <script src="js/createEnvironmentForClone.js"></script>
    <script src="js/saveCloneToTab.js"></script>
    <script src="js/updateCloneDestinationDisplay.js"></script>
    <script src="js/findProfileById.js"></script>
    <script src="js/populateEnvironmentTabsForClone.js"></script>
    <script src="js/populateProfileEnvironmentsForClone.js"></script>
    <script src="js/openCloneToTabModal.js"></script>
    <script src="js/cloneSelectedLinks.js"></script>
    <script src="js/updateSelectedDestinationDisplay.js"></script>
    <script src="js/BulkOperations.js"></script>
    <!-- updateBulkSelectionCount, moveSelectedLinks, deleteSelectedLinks, openBulkMoveLinkModal, cloneSelectedLinks, saveBulkMoveLinks
    populateProfileEnvironmentsForBulkMove, populateEnvironmentTabsForBulkMove, createEnvironmentForBulkMove, createTabForBulkMove-->
    <script src="js/SearchFunctions.js"></script>
    <!-- performSearch, clearSearch, applySearchHighlights -->
    <script src="js/counters.js"></script>
    <script src="js/migrateToVersionedStorage.js"></script>
    <script src="js/testStorageIsolation.js"></script>
    <script src="js/debugCurrentState.js"></script>
    <script src="js/findDuplicateElements.js"></script>
    <script src="js/verifyAllFixes.js"></script>
    <script src="js/outlook-email.js"></script>
    <script src="js/color-modal.js"></script>
    <!--reorder-block-->
    <script src="js/reorder-workbooks-modal.js"></script>
    <script src="js/reorder-profiles-modal.js"></script>
    <script src="js/reorder-environments-modal.js"></script>
    <script src="js/reorder-tabs-modal.js"></script>
    <script src="js/reorder-links-modal.js"></script>
    <!--reorder-block ends-->
    <!--rename-block-->
    <script src="js/renameWorkbook.js"></script>
    <script src="js/rename-workbook-modal.js"></script>
    <script src="js/renameProfile.js"></script>
    <script src="js/rename-profile-modal.js"></script>
    <script src="js/renameEnvironment.js"></script>
    <script src="js/rename-environment-modal.js"></script>
    <script src="js/renameTab.js"></script>
    <script src="js/rename-tab-modal.js"></script>
    <script src="js/editLink.js"></script>
    <script src="js/isValidUrl.js"></script>
    <script src="js/edit-link-modal.js"></script>
    <script src="js/createLinkCard.js"></script>
    <!--rename-block ends-->
    <script src="js/debugXMLImport.js"></script>
    <script src="js/importWorkbooks.js"></script>
    <script src="js/debugExportModal.js"></script>
    <!--move-block-->
    <script src="js/moveProfile.js"></script>
    <script src="js/move-profile-modal.js"></script>
    <script src="js/moveEnvironment.js"></script>
    <script src="js/move-environment-modal.js"></script>
    <script src="js/moveTab.js"></script>
    <script src="js/move-tab-modal.js"></script>
    <!--move-block ends-->

    <!-- Event listeners LAST -->
    <script src="js/event-listeners.js"></script>
    <!-- Event listeners LAST -->

</body>
</html> 